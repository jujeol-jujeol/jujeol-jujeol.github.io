---
layout: post
title: '[FE] 환경변수 설정하기 - dotenv & snowpack'
description: >
  react 프로젝트에서 dotenv로 환경변수 설정하기
tags: [jojal-jojal]
author: tyche
---

최종업데이트 : 2021.07.15

# 환경변수 설정하기

## ✔️ 환경변수를 설정한 이유
  - 개발을 진행하면서 local에서만 진행하는 것이 아니라, 배포된 서버에도 함께 테스트해야할 때가 있다.
  - local 환경에서 테스트 할 때에는, request를 보낼 때 BASE_URL을 localhost:8080(서버 로컬 주소)로 지정해두고 서버 로컬을 켜서 직접 요청값을 확인하는 과정이 있었다.
  - 하지만, 개발 서버로 테스트 하려면, 프론트엔드의 배포 서버와 백엔드의 배포 서버로 BASE_URL을 수정해야하는 번거로움이 있다.
  - 이러한 과정을 자동화를 해주는 방법으로 우리는 dotenv 라이브러리를 통한 환경변수 설정하기로 했다.

## ✔️ [dotenv](https://www.npmjs.com/package/dotenv) 라이브러리

### dotenv란? 
  - **`dotenv`는 환경변수를 `.env`파일에 저장하고 `process.env`로 로드하는 의존성 모듈이다.** [🖇 참고](https://velog.io/@reveloper-1311/DB-Node.js%EC%97%90%EC%84%9C-%ED%99%98%EA%B2%BD%EB%B3%80%EC%88%98-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0dotenv)
  
- 또다른 환경변수 라이브러리는 무엇이 있을까?
  - cross-env
    - 프로그램을 CLI 환경에서 실행시킬 때에 환경변수를 설정하는 기능을 가지고 있다.
    - 즉, dotenv는 미리 작성한 파일을 환경변수로 설정하고, [cross-env](https://www.npmjs.com/package/cross-env)는 콘솔(CLI)에 직접 입력하여 환경변수를 설정한다.
    - 업데이트 중지한다는 소식이..
    > 🚨 NOTICE: cross-env still works well, but is in maintenance mode. No new features will be added, only serious and common-case bugs will be fixed, and it will only be kept up-to-date with Node.js over time.


## ✔️ 설치 삽질의 여정

### 1. dotenv 설치

    ```
    npm install dotenv
    ```

### 2. [@snowpack/plugin-dotenv](https://www.npmjs.com/package/@snowpack/plugin-dotenv) 설치

    ```
    npm install --save-dev @snowpack/plugin-dotenv
    ```
<br >

    ```
    // snowpack.config.json
    {
      "plugins": ["@snowpack/plugin-dotenv"]
    }
    ```

  - 이부분 엄청 헤맸다^^; 처음에는 스크립트 실행으로 최상단에 .env 파일이 시행되길래, `어? 되는데?` 이런 생각으로 하는데 request를 사용하는 쪽에서 process.env.~ 로 입력한 부분에서 process.env이 undefined가 나오는 것이 아닌가..^^
  - 가장 중요한 부분은 아래 설정파일을 만들때 꼭 `SNOWPACK_PUBLIC_ prefix`를 붙여야한다는 것이다.
  - > ⚠️Snowpack requires the SNOWPACK_PUBLIC_ prefix to recognize environment variables. This is to prevent accidental exposure of keys and secrets.
   이부분 우리맘대로 고쳤다가 계속 안되는거 몰랏자나.. 👀

### 3. 설정파일 만들기 (frontend/env 폴더 생성)

  아마 필요에 의해서 gitignore를 해야할 수도 있을 것 같다.

  - local환경

        ```
        // .env.local

        SNOWPACK_PUBLIC_LOGIN_REDIRECT_URL=http://localhost:3000/ouath
        SNOWPACK_PUBLIC_API_URL=http://localhost:8080
        SNOWPACK_PUBLIC_KAKAO_CLIENT_ID=838bcd43c3b007b4ef38c3da555c4806
        ```

  - development 환경

        ```
        // .env.development

        SNOWPACK_PUBLIC_LOGIN_REDIRECT_URL=https://dev-fe-jujeol-jujeol.netlify.app/ouath
        SNOWPACK_PUBLIC_API_URL=https://jujeol.kro.kr
        SNOWPACK_PUBLIC_KAKAO_CLIENT_ID=838bcd43c3b007b4ef38c3da555c4806
        ```

  - ⚠️ SNOWPACK_PUBLIC은 snowpack을 사용한다면 필수이다.

### 4. npm script 작성

    ```
    //pacakge.json

    "scripts": {
        "start": "snowpack dev",
        "start:local": "cp ./env/.env.local ./.env && snowpack dev --polyfill-node", // 추가한 부분
        "start:dev": "cp ./env/.env.development ./.env && snowpack dev --polyfill-node", // 추가한 부분
        "build": "snowpack build",
        "build:local": "cp ./env/.env.local ./.env && snowpack build --polyfill-node", // 추가한 부분
        "build:dev": "cp ./env/.env.development ./.env && GENERATE_SOURCEMAP=false snowpack build --polyfill-node", // 추가한 부분
        "test": "jest src",
        "storybook": "start-storybook -p 6006",
        "storybook-build": "build-storybook",
        "type-check": "tsc"
      },
    ```

  - 명령어를 시행할 때는 npm run start:local과 같이 `npm run`을 해주어야 한다. npm start는 되는데? 왜 run을 붙여야하지? 라는 고민을 잠깐 했는데, 
  
  > [npm-run-script | npm Docs](https://docs.npmjs.com/cli/v7/commands/npm-run-script) <br> run[-script] is used by the test, start, restart, and stop commands, but can be called directly, as well. When the scripts in the package are printed out, they're separated into lifecycle (test, start, restart) and directly-run scripts.
  기존의 npm init을 하면 `npm test, start, restart, and stop는 생략이 가능한데` 나머지는 run을 붙여주어야 하는 것 같다.
  
  - `npm run, npm rum, npm urn`도 다 지원해준다. ~~(을마나 오타를 많이 냈으면..)~~
  심지어 `npm run-script`가 원래 full syntax이다.

  - ⚠️ npm script에서 `--polyfill-node`를 붙여준 이유
    다음과 같은 에러가 떠서, snowpack이 시키는대로 맨 뒤에 붙여주었다. 궁금한 점은 한번 오류가 떠서 `--polyfill-node`를 붙여줘서 해결하고, 다시 삭제를 했는데 snowpack에서 캐싱을 하는 건지 오류가 안나더라.. 😢
  <img width="885" alt="polyfillnode 관련 에러이미지" src="/assets/img/20210715/polyfillerror.png">

  - [🖐 가능합니다. 확인완료] 개인적인 생각으로는 설정파일에 다음과 같이 쓰면 저 문구를 script에서 모두 생략할 수 있을 것 같다는 느낌이..? [🖇 공식문서](https://snowpack-git-config-api-finalize.pikapkg.vercel.app/reference/configuration#installoptions.polyfillnode-%7C-boolean)


        ```
        //snowpack.config.json

        module.exports = {
          installOptions: {
            polyfillNode: true
          },
        };
        ```<img width="689" alt="스크린샷 2021-07-16 오전 12 47 02" src="https://user-images.githubusercontent.com/59258239/125817524-949380aa-c73f-4204-9a2c-a5253f38e7cb.png">

        
   🖇 [Polyfill - 용어 사전 | MDN](https://developer.mozilla.org/ko/docs/Glossary/Polyfill)이란?

### 5. 환경변수를 사용하는 곳에서 코드 수정하기

    ```
    const BASE_URL = process.env.SNOWPACK_PUBLIC_API_URL;
    ```

### 6 최상단 파일에서(또는 사용하는 파일에서) dotenv import 하기

    ```
    import dotenv from 'dotenv';

    dotenv.config();
    ```


  <img width="689" alt="dotenv의 import 하는 방법에 대한 npm dotenv 설명" src="/assets/img/20210715/dotenv.png">


## ✔️ 이어지는 글에는..

현재 배포를 netlify를 통해서 하고 있는데, 이 안에서 build command를 통해서 .env 파일에 있는 내용을 작성할 수 있다고 한다. 다음에 데모데이때 배포할 때 추가로 작성해보겠다.

### ✔️ 기타

환경변수란?

- 환경변수는 OS입장에서 해당 프로세스를 실행시키기 위하여 참조하는 변수


### 🖇 참고문서
- [dotenv](https://www.npmjs.com/package/dotenv) 라이브러리
- [dotenv 및 환경변수 정리 블로그 글](https://velog.io/@reveloper-1311/DB-Node.js%EC%97%90%EC%84%9C-%ED%99%98%EA%B2%BD%EB%B3%80%EC%88%98-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0dotenv)
- [cross-env](https://www.npmjs.com/package/cross-env)
- [@snowpack/plugin-dotenv](https://www.npmjs.com/package/@snowpack/plugin-dotenv)
- [snowpack/polyfillnode](https://snowpack-git-config-api-finalize.pikapkg.vercel.app/reference/configuration#installoptions.polyfillnode-%7C-boolean)
- [npm-run-script | npm Docs](https://docs.npmjs.com/cli/v7/commands/npm-run-script)
- [Polyfill - 용어 사전 | MDN](https://developer.mozilla.org/ko/docs/Glossary/Polyfill)
